!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Gama=t():e.Gama=t()}(this,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};let n,i,o,a,r,d;function c(e,t){var n=e.getSelectedNodes()[0],i=t?n.getNextNode():n.getPreNode();if(i){var o=i.extra.split("_");s(o[0],o[1]),e.selectNode(i)}else l(e,t)}function l(e,t){var n=e.getNodeByParam("extra",o.attrs.id),i=t?n.getNextNode():n.getPreNode();if(i){var a=t?i.children[0]:i.children[i.children.length-1],r=a.extra.split("_");s(r[0],r[1]),i.open||e.expandNode(i),e.selectNode(a)}}function s(e,t){if(!o||o.id!=e||a.id!=t){a&&a.hide();var i=n.find("#"+e);i.length?o=i[0]:g(e),function(e,t,n,i){return new Promise((o=>{var a=e.length?e[0].find("#"+n)[0]:null;if(a)o({pageGroup:a,isNew:!1});else{$(".loading-banner").show();var r=i.replace("{docId}",t).replace("{pageId}",n);$.get(r).done((function(e){setTimeout((()=>{o(function(e){var t=new Konva.Group({id:e.id}),n=new Image;n.onload=function(){var e=new Konva.Image({x:50,y:50,image:n,name:"page-image",stroke:"red",strokeWidth:2});t.add(e)},n.src=e.url;var i=new Konva.Group({name:"boxes"});return t.add(i),{pageGroup:t,isNew:!0}}(e)),$(".loading-banner").hide()}),10)})).fail((()=>o(0)))}}))}(i,e,t,r).then((e=>{e&&(e.isNew&&o.add(e.pageGroup),a=e.pageGroup,a.show())}))}}function g(e){var t=new Konva.Group({id:e});i.add(t),o=t}e.r(t),e.d(t,{init:()=>m});const u={view:{selectedMulti:!1},edit:{drag:{autoExpandTrigger:!0,prev:!0,inner:function(e,t,n){return!n||n.isParent},next:!0,isMove:!1,isCopy:!0},enable:!0,showRemoveBtn:function(e,t){return t.isCopy}},callback:{onDrop:function(e,t,i,a,r){if(i.length&&a){a.isParent||(a=a.getParentNode());var c=i[0],l=c.extra;c.isCopy=!0,c.name="página "+a.children.length+" (cópia)",c.extra=a.extra+"_page"+a.children.length,d.updateNode(c),function(e,t){e=e.split("_"),t=t.split("_");var i=n.find("#"+e[0])[0].find("#"+e[1])[0],a=i.clone({id:t[1]}),r=i.children[1].attrs.image.cloneNode();if(a.children[1].attrs.image=r,e[0]==t[0])return i.getParent().add(a),void s(t[0],t[1]);n.find("#"+t[0]).length||g(t[0]),o.add(a),s(t[0],t[1])}(l,c.extra),console.log(a)}},beforeDrag:function(e,t){return!!t[0].canDrag&&1},onClick:function(e,t,n){if(!n.isParent){var i=n.extra.split("_");s(i[0],i[1]),n.canDrag=!0}}},data:{keep:{parent:!0,leaf:!0}}};function f(){c(d,!0)}function h(){c(d,!1)}function p(){l(d,!0)}function v(){l(d,!1)}function m(e){var t;(function(e){var t,d,c,l,s,g=document.getElementById(e.konvaContainerId);r=e.getPageUrl,n=new Konva.Stage({container:g.id,width:g.offsetWidth,height:g.offsetHeight}),i=new Konva.Layer,n.add(i),(s=new Konva.Rect({stroke:"black",strokeWidth:1,dash:[5,2],visible:!1})).zIndex(2),n.on("mousedown touchstart",(e=>{(e.target!==n||o)&&(e.evt.preventDefault(),o.add(s),t=n.getPointerPosition().x,d=n.getPointerPosition().y,c=n.getPointerPosition().x,l=n.getPointerPosition().y,s.visible(!0),s.width(0),s.height(0))})),n.on("mousemove touchmove",(e=>{s.visible()&&(e.evt.preventDefault(),c=n.getPointerPosition().x,l=n.getPointerPosition().y,s.setAttrs({x:Math.min(t,c),y:Math.min(d,l),width:Math.abs(c-t),height:Math.abs(l-d)}))})),n.on("mouseup touchend",(e=>{if(s.visible()){e.evt.preventDefault(),setTimeout((()=>{s.visible(!1)}));var t=s.getClientRect(),n=a.find(".page-image")[0],i=document.createElement("canvas");i.width=t.width,i.height=t.height;var o=i.getContext("2d"),r=n.attrs.x,d=n.attrs.y,c=(n.width(),n.height(),t.width),l=t.height,g=t.x,u=t.y;o.drawImage(n.attrs.image,g-r,u-d,c,l,0,0,c,l),n.attrs.image.src=i.toDataURL()}})),n.on("click tap",(function(e){s.visible()||e.target!==n&&e.target.hasName("rect")&&(e.evt.shiftKey||e.evt.ctrlKey||e.evt.metaKey)}))})(e),t=e.zTree,$((function(){d=$.fn.zTree.getZTreeObj(t.id),$.extend(!0,d.setting,u),$(t.nextPageSelector).on("click",f),$(t.prevPageSelector).on("click",h),$(t.nextDocumentSelector).on("click",p),$(t.prevDocumentSelector).on("click",v)}))}return t})()));